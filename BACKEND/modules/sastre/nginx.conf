# SASTRE nginx config for Docker
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=investigate:10m rate=2r/s;

upstream orchestrator {
    server sastre-orchestrator:8201;
}

upstream metrics {
    server sastre-metrics:9090;
}

server {
    listen 80;
    
    location /health {
        proxy_pass http://orchestrator/health;
    }
    
    location /metrics {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://metrics/metrics;
    }
    
    location ~ ^/api/v1/investigate {
        limit_req zone=investigate burst=5 nodelay;
        proxy_pass http://orchestrator;
        proxy_read_timeout 600s;
    }
    
    location /ws {
        proxy_pass http://orchestrator;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
    }
    
    location / {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://orchestrator;
    }
}
