# SASTRE AI - Production Docker Compose
version: "3.8"

services:
  # Main orchestrator service
  sastre-orchestrator:
    build: .
    container_name: sastre-orchestrator
    restart: always
    ports:
      - "8201:8201"
    environment:
      - PYTHONPATH=/app
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - SASTRE_JWT_SECRET=${SASTRE_JWT_SECRET}
      - SASTRE_AUTH_ENABLED=${SASTRE_AUTH_ENABLED:-false}
      - NODE_API_BASE_URL=http://host.docker.internal:3000
    volumes:
      - sastre-data:/app/data
      - ./users.json:/app/SASTRE/users.json
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8201/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - sastre-net

  # Metrics server
  sastre-metrics:
    build: .
    container_name: sastre-metrics
    restart: always
    command: python -m SASTRE.metrics_server
    ports:
      - "9090:9090"
    environment:
      - PYTHONPATH=/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - sastre-net

  # Prometheus (optional - for metrics collection)
  prometheus:
    image: prom/prometheus:latest
    container_name: sastre-prometheus
    restart: always
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/prometheus_alerts.yml:/etc/prometheus/alerts.yml
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    networks:
      - sastre-net

  # Grafana (optional - for dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: sastre-grafana
    restart: always
    ports:
      - "3030:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=sastre-admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana_dashboard.json:/var/lib/grafana/dashboards/sastre.json
    networks:
      - sastre-net

  # nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: sastre-nginx
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - sastre-orchestrator
      - sastre-metrics
    networks:
      - sastre-net

volumes:
  sastre-data:
  prometheus-data:
  grafana-data:

networks:
  sastre-net:
    driver: bridge
